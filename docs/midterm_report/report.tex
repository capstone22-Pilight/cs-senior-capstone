\documentclass[oneside,openright]{book}
\usepackage{listings}
\usepackage{underscore}
\usepackage[breaklinks]{hyperref}
\usepackage{url}
\usepackage{breakurl}
\usepackage{atbegshi}% http://ctan.org/pkg/atbegshi
\AtBeginDocument{\AtBeginShipoutNext{\AtBeginShipoutDiscard}}
\renewcommand\thesection{\arabic{section}}
\renewcommand{\bibname}{References}
\lstset{ %
   language=C++,                % choose the language of the code
   basicstyle=\small,        % the size of the fonts that are used for the code
   keywordstyle=\color{blue},
   stringstyle=\color{red},
   commentstyle=\color{green},
   numbers=left,                   % where to put the line-numbers
   numberstyle=\footnotesize,      % the size of the fonts that are used for the line-numbers
   stepnumber=1,                   % the step between two line-numbers. If it is 1 e ach line will be numbered
   numbersep=5pt,                  % how far the line-numbers are from the code
   backgroundcolor=\color{white},  % choose the background color. You must add \usep ackage{color}
   showspaces=false,               % show spaces adding particular underscores
   showstringspaces=false,         % underline spaces within strings
   showtabs=false,                 % show tabs within strings adding particular unde rscores
   frame=single,           % adds a frame around the code
   tabsize=2,          % sets default tabsize to 2 spaces
   captionpos=b,           % sets the caption-position to bottom
   breaklines=true,        % sets automatic line breaking
   breakatwhitespace=false,    % sets if automatic breaks should only happen at whitespace
   escapeinside={\%*}{*)}          % if you want to add a comment within your codey
   }
\hypersetup{
    bookmarks=false, % show bookmarks bar?
    pdftitle={Software Requirement Specification}, % title
    pdfauthor={Malcom Diller, Evan Steele, Sean Rettig}, % author
    pdfsubject={Raspberry Pi Outdoor Lighting}, % subject of the document
    pdfkeywords={TeX, LaTeX, graphics, images}, % list of keywords
    colorlinks=true, % false: boxed links; true: colored links
    linkcolor=blue, % color of internal links
    citecolor=black, % color of links to bibliography
    filecolor=black, % color of file links
    urlcolor=blue, % color of external links
  %linktoc=page % only page is linked
}
\def\myversion{1.0 }
\title{
	\flushright
		\rule{16cm}{5pt}\vskip1cm
		\Huge{MIDTERM REPORT}\\
	for\\
		\vspace{2cm}
	Not Exactly the Internet of Things for Outdoor Lighting\\
		\vspace{2cm}
	\LARGE{Progress Report:}
	\vspace{2cm}
	\LARGE{Alpha Stage\\}
	\vspace{2cm}
	Malcolm Diller, Sean Rettig, and Evan Steele\\
        Client: Victor Hsu\\
        OSU CS Senior Capstone Group 22
		\vfill
		\rule{16cm}{5pt}
}

\date{}
\usepackage{hyperref}
\renewcommand{\contentsname}{PiLight}
\begin{document}
\pagenumbering{gobble}
\maketitle
\tableofcontents
\newpage
\pagenumbering{arabic}
\section{Introduction}

\section{Status}

At this point in the project, all alpha-level features have been implemented;
all planned user interface pages and their corresponding elements have been
created and at least stubbed; not all elements are fully functional yet.
However, many of the elements are already at beta-level functionality:

\begin{itemize}
    \item The ESP firmware has been written and can automatically connect to
        the Pi wirelessly.
    \item The Pi is loaded with our custom build of Yocto Linux and can act as
        a wireless router for the ESPs to connect to.
    \item The Pi is set up to run our Flask web site, and it can be connected 
        to by wireless devices and viewed in a browser.
    \item The flask website has an SQL database that stores information about 
        the lights, groups, devices, and users
    \item The web interface has a main page that lists all available lights,
        where lights can be renamed and sorted into groups.
    \item Groups in the main page can also be created, renamed, nested into 
        each other, and deleted, though deletion has not been fully implemented yet.
    \item The web interface has an advanced page for each light/group where
        rules for when to automatically toggle on/off can be created.
    \item All types of rules (including time of day, day of week, day of month,
        day of year, specific dates, sunrise/sunset times, and even parent
        interaction and offsets/staggering) are available to be created.
    \item The web interface has a login screen.
    \item The web interface has a device pairing screen.
\end{itemize}

\section{Work in Progress}
\subsection{Device Communication}
One of the current post-Alpha goals is to complete the communication mechanism between the Raspberry Pi and the ESP8266 modules. We are working on finalizing our logical evaluation subsystem and determining what do to in the case of manual user override. The databases and communication parameters have been completed, as in we know what the function that will flip the lights themselves expects, but we don't know how to perform our Python-based evaluations yet. We expect that it will come shortly after finishing up the advanced query editor, at which point we expect to have a format and value range locked down for the queries to be evaluated.\\

The devices are already prepared in a database to draw from, using the MAC address as the unique key to locate the IP address from the table. We don't anticipate the ISC DHCP server flipping addresses around, but by using the physical hardware addresses we are eliminating any possibility of sending the code to the wrong device. The Python ISC DHCP library provides us with a mechanism for determining if a device's IP has changed, and we will write that change to the devices table.

\subsection{User Interface/Website}
Much of the functionality that we need for Beta is already built in. There are only a few buttons that don't do anything and need to be implemented in order to get Beta functionality up and running for the website. The database has been created and much of the website already uses it, but there are a few parts of the interface that have not been tied in. 

\section{Problems}
\subsection{Wireless}
We had an issue early on with how we planned to connect to the ESP8266 modules using our Raspberry Pi. Our proof-of-concept had the client connecting to the wireless module itself to make changes, but we wanted remote management to work from the Pi and have it be reachable from the internet. We began looking into ways to perform local routing so that the device could play with the end-user's home network, but ran into more snags trying to configure multiple wireless network devices on the same Pi. We contacted our client who suggested that we not worry about external connectivity for the project. His expectations were that users would directly connect to the Pi to make configuration changes. The project title was "not \textit{exactly} the Internet-of-Things", after all.\\

To fix the issue, we reconfigured the Raspberry Pi so we could connect wirelessly. We needed to first recompile \textit{hostapd} to run with a version of our USB wireless driver that could broadcast an SSID. After recompiling we confirmed that we could connect using a wireless device such as a smartphone. The other task was to change the firmware on the ESP8266 so that it behaves like a client instead of a host. In addition to flashing the new firmware, a startup file was added so that it automatically connects to the nearest Raspberry Pi with "Pilight" in the SSID. We will likely change this later to better incorporate new devices.

\subsection{Pulse Width Modulation}
We had the idea that a device managable via the Raspberry Pi would be able to control the brightness of the lights using PWM. Unfortunately the 10A gates on our relay just can't flip fast enough for any desired pulses. Our group contacted our client to see if it was worth the trouble of acquiring a relay unit that could do PWM, but his response was that he was only concerned with turning the devices on and off. We also considered a software-defined PWM solution, but were again affected by the speed of the relay itself not being sufficient.

\subsection{Behavior of On/Off Switches}
Before starting to implement the rules, we had not put much thought into what the behavior should be for the On/Off switches of the lights and groups. After we began to implement more of the project we realized that there are a few ways that the behavior could be implemented:
\begin{enumerate}
  \item Toggling the switch would change the state of the light until the user chose to resume automated control
  \item Toggling the switch would change the state of the light for a preset amount of time before resuming automated control.
  \item Toggling the switch would change the state of the light until the next time that the rules determined the light should change, upon which automated control would resume.
\end{enumerate}
The are benefits to each implementation and it was a difficult decision to figure out which path we should take. The first option makes sense because the user is never overridden by the system. The second option is useful because the user most likely is turning on the light for a temporary purpose, and probably will not want to have to go into the advanced settings all the time. We decided to go with the third option, as it provided the benifits of the second option, but more cleanly eases back into the pattern of automated control.

\section{Code}
\subsection{Acquire New Devices}
This code, upon user request, scans currently connected devices for a new ESP8266 device that does not already exist in the devices database.
\begin{lstlisting}
   // Get all DHCP leases currently given out
   leases = IscDhcpLeases('/var/lib/dhcp/dhcpd.leases')
   leases = leases.get()

   // No DHCP leases at all, the server is not operating
   if not leases:
      return "NODHCP"

   additions = 0
   // For each lease, first see if it is an ESP8266
   for iteration,lease in enumerate(leases):
      if(ESP8266_check(lease.ip)):
      // We have an ESP8266 mode!
         database_check = model.Device.query.filter_by(mac=lease.ethernet).first()
         if database_check is None:
         // We have an ESP8266 AND it is not in the database!
            new_device = model.Device(mac=lease.ethernet,ipaddr=lease.ip,name="ESP8266@"+lease.ethernet)
            model.db.session.add(new_device)
            model.db.session.commit()
            additions = additions + 1
      return str(additions)
   \end{lstlisting}
\subsection{Editing Lights and Groups}
We decided to use the X-editable library for executing inline edits to the names of groups and lights. This involved creating a span element to represent the name with information about the light or group embedded in it. We then included a few lines of javascript to specify where to send the post request and setup the editable span element. When submitted, a post request would be sent to the flask server. Below is the flask function that handles the post request and changes the name of a light or group in the database.
\begin{lstlisting}
@app.route('/change_name', methods=['POST'])
def change_name():
    name = request.form['value']
    pk = request.form['pk']
    isLight = request.form['name'] == "light"
    if isLight:
        light = model.Light.query.filter_by(id=pk).first()
        light.name = name
    else:
        group = model.Group.query.filter_by(id=pk).first()
        group.name = name
    model.db.session.commit()
    return "Success!"
\end{lstlisting}
\section{First User Study}
\subsection{Usability}
After exploring the interface for a time, the user was asked to perform a series of tasks, and the following is a description of what the user did when asked to perform each task.
\begin{itemize}
  \item Login \\
    The user clicked on the Username box, entered a username, clicked on the password box, entered a password, and then clicked on the SignIn button.
  \item Logout \\
    The user clicked on the Logout link in the top menu bar.
  \item Adding a device \\
    The user clicked on the Add Devices button. The were confused by the loading animation and suggested that there should be text to indicate what is going on.
  \item Change the name of a group or a light \\
    The user clicked on the name of the light, typed in the new name, and pressed enter.
  \item Identify how the group/light heirarchy functioned \\
    The user noted that the groups appeared to own other groups, and that all of the lights were owned by a group. They were also able to determine that the groups could be used to control all of the lights within that group.
  \item Manually toggle a light off \\
    The user clicked on the switch to turn the light off.
  \item Deleting a group \\
    The user clicked on the red "x" at the right of one of the group rows.
  \item Move a light to a different group \\
    The user identified the move icon as the correct tool for moving rows, but had difficulty clicking on it, as the spaces inbetween the arrows do not register a click. Once they had grabbed it and were moving it, they were then slightly confused because there was no preview of the destination, and instead the light was attached to the mouse. They did drop it and move the light correctly, but they noted that the task was slightly less intuitive than the previous ones.
  \item Adding a group \\
    The user clicked on the New Group button.
  \item Navigating to the place where one could change the settings or rules of a light or group \\
    The user clicked on the gear at the right of a row to bring them to the advanced page.
  \item Set the light to turn on at sunset and turn off at sunrise \\
    The user clicked the radio button for sunset under the Turn On At category, and the button for sunrise in the Turn Off At category. The user then noted that they were not sure whether they needed to do anything else to save what they had done. They felt like they should click a "Save Changes" or "Submit" button
  \item Set the light to turn off at four in the morning \\
    The user clicked on the Time radio button under the Turn Off At category, and entered in the time 4:00 AM.
  \item Set the light to turn off at sunset and on at sunrise for every day of the week, with the exception of making it turn on at 4:00 PM on Monday. \\
    The user was unable to do this as it was not obvious to them how the rule system worked. After it was explained to them, they suggested that the New Rule and rules controls should be at the bottom of the page, and that the wording should be changed to something other than "Rule.".
\end{itemize}
\subsection{Suggested Improvements}
The user made the following suggestions on how they thought the user interface could be improved.
\begin{itemize}
  \item Switches should be green/red, not blue/gray.
  \item Switches are too slow, should be twice the speed.
  \item Switches should show "On" and "Off" text.
  \item When adding a new group, the switch should be set to Off.
  \item Groups should have two on and off buttons instead of switches, and should not have a state. The intermediate state of the switch does not make sense.
  \item Menu bar should have greater contrast so it is more noticable.
  \item While waiting after hitting the Add Device button, there should be "searching" text to give the user a reason for waiting.
  \item SignIn in the login page should be Sign In
  \item When dragging and dropping lights or groups, there should be a preview of the destination while the user is holding it.
  \item Advanced query box should be moved to bottom of page or hidden in something like an expanding box, as most users will not want to see or understand it.
  \item There should be a more clear way to submit the changes made to a rule.
  \item There should be a preview of the rules for a group or light when hovering over the name or the link leading to the advanced page.
  \item The wording "Rule" should be changed to something that represents the idea more clearly.
\end{itemize}
As we conducted this user study near the end of Alpha stage, we have yet to decide whether to implement the suggested changes and have yet to make any changes as a result of the usability tests. We will go over these in the future and make judgements about what changes should be made then.
\newpage
\Urlmuskip=0mu plus 1mu\relax
\bibliography{design}{}
\bibliographystyle{IEEEtran}

\end{document}
